[uwsgi]
strict = true
plugins = tuntap,quota,eventfd
emperor = /containers/{{container.uid}}/vassals
emperor-stats-server = 127.0.0.1:5005

auto-procname = true
procname-prefix-spaced = [{{container.uid}}]

hook-asap = setquota:{{container.server.hd}} {{container.uid}} {{container.quota}}

if-not-dir = /containers/{{container.uid}}
hook-asap = mkdir:/containers/{{container.uid}}
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}
endif =

if-not-dir = /containers/{{container.uid}}/run
hook-asap = mkdir:/containers/{{container.uid}}/run
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/run
endif =

if-not-dir = /sys/fs/cgroup/{{container.uid}}
hook-asap = mkdir:/sys/fs/cgroup/{{container.uid}}
endif =

hook-asap = write:/sys/fs/cgroup/{{container.uid}}/memory.limit_in_bytes {{container.memory_limit_in_bytes}}
hook-asap = write:/sys/fs/cgroup/{{container.uid}}/memory.swappiness 0

if-not-dir = /containers/{{container.uid}}/run/subscribe
hook-asap = mkdir:/containers/{{container.uid}}/run/subscribe
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/run/subscribe
endif =

if-not-dir = /containers/{{container.uid}}/run/cgroup
hook-asap = mkdir:/containers/{{container.uid}}/run/cgroup
endif =

if-not-dir = /containers/{{container.uid}}/vassals
hook-asap = mkdir:/containers/{{container.uid}}/vassals
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/vassals
endif =

if-not-dir = /containers/{{container.uid}}/.old_root/{{container.uid}}
hook-asap = mkdir:/containers/{{container.uid}}/.old_root/{{container.uid}}
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/.old_root
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/.old_root/{{container.uid}}
endif =


if-not-dir = /containers/{{container.uid}}/tmp
hook-asap = mkdir:/containers/{{container.uid}}/tmp
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/tmp
endif =

if-not-dir = /containers/{{container.uid}}/logs
hook-asap = mkdir:/containers/{{container.uid}}/logs
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/logs
endif =

if-not-dir = /containers/{{container.uid}}/.ssh
hook-asap = mkdir:/containers/{{container.uid}}/.ssh
hook-asap = exec:chown {{container.uid}}:{{container.uid}} /containers/{{container.uid}}/.ssh
endif =

if-file = /containers/{{container.uid}}/.ssh/uwsgi_authorized_keys
hook-asap = unlink:/containers/{{container.uid}}/.ssh/uwsgi_authorized_keys
endif =
{% for key in container.ssh_keys %}
hook-asap = appendn:/containers/{{container.uid}}/.ssh/uwsgi_authorized_keys {{key}}
{% endfor %}

hook-asap = hostname:{{hostname}}
jailed = true
exit-on-reload = true

hook-pre-jail = callret:chdir /
hook-pre-jail = mount:none /distros/{{distro}} /ns bind

pivot_root = /ns /ns/.old_root

hook-as-root = mount:proc none /proc nodev hidepid=2
hook-as-root = mount:none /.old_root/dev /dev bind
hook-as-root = mount:none /.old_root/dev/pts /dev/pts bind
hook-as-root = mount:none /.old_root/containers/{{container.uid}}/.old_root /containers bind
hook-as-root = mount:none /.old_root/containers/{{container.uid}} /containers/{{container.uid}} bind
hook-as-root = mount:none /containers/{{container.uid}}/run /run bind,nosuid
hook-as-root = mount:none /containers/{{container.uid}}/tmp /tmp bind,nosuid
hook-as-root = mount:none /.old_root/subscribe /run/subscribe bind
hook-as-root = mount:none /.old_root/sys/fs/cgroup/{{container.uid}} /run/cgroup bind
hook-as-root = umount:/.old_root rec,detach
hook-as-root = mount:none none / remount,nosuid
hook-as-root = mount:none /containers/{{container.uid}} /containers/{{container.uid}} remount,nosuid
hook-as-root = mount:none /.old_root /var/log bind,nosuid
hook-as-root = exec:ifconfig lo up
hook-as-root = exec:ifconfig uwsgi0 {{container.ip}} netmask 255.0.0.0 up
hook-as-root = exec:chgrp {{container.uid}} /containers/{{container.uid}}/logs/emperor.log
hook-as-root = exec:route add default gw 10.0.0.1

setns-socket = /run/ns.socket
setns-preopen = true
tuntap-device = uwsgi0 /run/tuntap_router.socket

uid = {{container.uid}}
gid = {{container.uid}}

logto = /containers/{{container.uid}}/logs/emperor.log

{% for rule in container.rules %}
tuntap-device-rule = {{rule.direction}} {{rule.src}} {{rule.dst}} {{rule.action}} {{rule.target}}
{% endfor %}
tuntap-device-rule = in 10.0.0.0/8 0.0.0.0 deny
tuntap-device-rule = out 0.0.0.0 10.0.0.0/8 deny

subscriptions-use-credentials = true
tuntap-use-credentials = true
